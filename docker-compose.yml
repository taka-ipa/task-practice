
services:
  db:
    image: mysql:8.0
    container_name: task-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: app_db
      MYSQL_USER: app_user
      MYSQL_PASSWORD: app_pass
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_0900_ai_ci
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-prootpass"]
      interval: 5s
      timeout: 3s
      retries: 30

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: task-backend
    working_dir: /var/www/html
    volumes:
      - ./backend:/var/www/html
      # ★ 一旦コメントアウト！
      # - backend_vendor:/var/www/html/vendor
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"
    # 最初は .env がまだ無いかもなので、ここは慣れるまでコメントアウト推奨
    # .env できたらコメント外してOK
    # env_file:
    #   - ./backend/.env
    command:
      - sh
      - -lc
      - |
          set -e
          # 1. 依存インストール
          if [ -f composer.json ]; then
            composer install --no-interaction
          fi

          # 2. .env が無ければコピー
          if [ ! -f .env ] && [ -f .env.example ]; then
            cp .env.example .env
          fi

          # 3. APP_KEY がまだなら発行
          if [ -f .env ]; then
            grep -q '^APP_KEY=base64:' .env || php artisan key:generate --force
          fi

          # 4. キャッシュクリア
          php artisan config:clear || true

          # 5. マイグレーション（DB接続できない時はエラーにして止める）
          php artisan migrate --force

          # 6. 開発用ビルトインサーバ起動
          php -S 0.0.0.0:8000 -t public public/index.php

  frontend:
    # Intel Mac なので arm64 じゃなくて amd64 にしておく
    platform: linux/amd64
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: task-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app:delegated
      - node_modules:/app/node_modules
      - next_cache:/app/.next
    environment:
      # ブラウザから叩く用。とりあえず localhost でOK
      NEXT_PUBLIC_API_BASE_URL: http://localhost:8000
      NEXT_TELEMETRY_DISABLED: "1"
      NODE_OPTIONS: --max-old-space-size=4096
      WATCHPACK_POLLING: "0"
    ports:
      - "3000:3000"
    command:
      - sh
      - -lc
      - |
        if [ ! -d node_modules ] || [ ! -f node_modules/.installed ]; then
          npm ci --no-audit --progress=false
          touch node_modules/.installed
        fi
        npm run dev

volumes:
  db_data:
  backend_vendor:
  node_modules:
  next_cache:
